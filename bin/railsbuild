#!/bin/bash -e
# Test a rails project.

# default variables
export PROJECT_DIR=`pwd`
export CI_BRANCH=${NODE_LABELS:-master}
export CI_JOB=${JOB_NAME:-project}
export CI_RVM_RUBY=${CI_RVM_RUBY:-"1.9.2"}
# For now, use the same gemset for all jobs.
#export CI_RVM_USE=${CI_RVM_USE:-"$CI_RVM_RUBY@ci_${CI_JOB}_${CI_BRANCH}"
#export CI_RVM_USE=${CI_RVM_USE:-"$CI_RVM_RUBY@ci_jobs"}

# Choose 'reset' to load from schema, or 'migrate' to migrate existing database.
export CI_DB_PREP=${CI_DB_PREP:-reset}

[[ -s "$HOME/.rvm/scripts/rvm" ]] && . "$HOME/.rvm/scripts/rvm"  # This loads RVM into a shell session.

if ! [[ `type rvm | head -1` == "rvm is a function" ]]; then
  echo "rvm is not installed correctly."
  exit 1
fi

# Use the correct ruby
rvm use $CI_RVM_USE

# install bundler if not yet installed.
if ! gem query -i -n bundler; then
  gem install bundler --no-rdoc --no-ri
fi

# Install bundle if dependencies have changed.
if ! bundle check; then
  echo "Bundle check failed. Installing bundle."
  # Shared gems may be faster than deployment flag because they don't need installing.
  #if ! ( bundle install --local --deployment || bundle install --deployment); then
  if ! ( bundle install --local || bundle install ); then
    echo "Gem bundle was not installed correctly."
    exit 1
  fi
fi

# Setup the rails project database.yml
setup_database.rb

case $CI_DB_PREP in
  reset)
    rake db:reset  # must be done separately from other tasks.
    dbprep_tasks='db:test:prepare'
    ;;
  migrate)
    dbprep_tasks='db:create db:migrate db:test:prepare'
    ;;
  *)
    echo "Invalid CI_DB_PREP option. Must be 'reset' or 'migrate'".
    exit 1;
    ;;
esac

# Finally, run your tests

# Run commands related to ci, if any.
# Otherwise run regular specs.
if [[ -n "$1" ]]; then
  rake $dbprep_tasks $1
else
  rake $dbprep_tasks spec
fi

